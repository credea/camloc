<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <title>Absensi Kamera</title>

    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin: 0;
        padding: 1rem;
        background: #f5f5f5;
      }

      video {
        width: 100%;
        max-width: 320px;
        border-radius: 10px;
        background: #000;
      }

      button {
        display: block;
        margin: 1rem auto;
        padding: 0.8rem 1.2rem;
        font-size: 1.2rem;
        border: none;
        border-radius: 8px;
        background: #28a745;
        color: white;
        cursor: pointer;
      }

      button:active {
        background: #218838;
      }

      #status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }

      #location {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
    </style>
  </head>

  <body>
    <h3>üì∑ Absensi dengan Foto</h3>

    <video id="video" autoplay playsinline muted></video>
    <p id="status">‚è≥ Loading kamera...</p>
    <p id="location"></p>
    <p
      id="debug"
      style="font-size: 12px; color: #444; white-space: pre-line"
    ></p>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const video = document.getElementById("video");
      const status = document.getElementById("status");
      const locText = document.getElementById("location");

      let lastLocation = null;
      let locationRetry = 0;
      const MIN_ACCURACY = 25; // meter
      const MAX_RETRY = 3;

      function debug(msg) {
        const el = document.getElementById("debug");
        el.innerText += msg + "\n";
      }

      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });

          video.srcObject = stream;
          await video.play();
          status.innerText = "‚úÖ Kamera aktif";

          // Setelah kamera aktif ‚Üí ambil lokasi awal
          setTimeout(() => getLocationBackground(), 500);
        } catch (err) {
          status.innerText = "‚ùå Gagal akses kamera: " + err.message;
        }
      }

      startCamera();

      // -------------------------
      // FUNGSI GET LOCATION
      // -------------------------
      function getLocation() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) return resolve(null);

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              resolve({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
              });
            },
            (err) => {
              tg.showAlert(
                "‚ö†Ô∏è Aktifkan lokasi untuk Telegram.\nError: " + err.message
              );
              resolve(null); // jangan menghentikan program, tetap lanjut
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 3000 }
          );
        });
      }

      // -------------------------
      // GET LOCATION OTOMATIS SETELAH KAMERA AKTIF
      // -------------------------
      async function getLocationBackground() {
        locText.innerText = "üìç Mengambil lokasi...";
        tg.MainButton.hide(); // tombol disembunyikan dulu

        lastLocation = await getLocation();

        if (lastLocation) {
          locText.innerText =
            `üìç Lokasi: ${lastLocation.lat.toFixed(
              5
            )}, ${lastLocation.lng.toFixed(5)}` +
            ` (¬±${lastLocation.accuracy}m)`;
        } else {
          locText.innerText = "üìç Lokasi tidak tersedia";
        }

        // CEK AKURASI
        if (lastLocation && lastLocation.accuracy <= MIN_ACCURACY) {
          tg.MainButton.show();
          return; // selesai
        }

        // Jika akurasi buruk ‚Üí cek apakah sudah 3x
        if (locationRetry < MAX_RETRY) {
          locationRetry++;
          locText.innerText += `\n‚è≥ Mencari lokasi lebih akurat... (percobaan ${locationRetry})`;
          setTimeout(getLocationBackground, 3000); // ulang lagi
        } else {
          // SUDAH 3x COBA, berhenti
          locText.innerText +=
            "\n‚ö†Ô∏è Lokasi tidak cukup akurat (maks 3 percobaan).";
          tg.MainButton.show();
        }
      }

      // -------------------------
      // BUTTON ABSEN
      // -------------------------
      tg.MainButton.setText("‚úÖ Absen");
      tg.MainButton.show();

      tg.MainButton.onClick(async () => {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        if (!canvas.width || !canvas.height) {
          tg.showAlert("‚ùå Video belum siap!");
          return;
        }

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        //const base64 = canvas.toDataURL("image/jpeg", 0.8);

        status.innerText = "üì§ Mengirim ke server...";

        // Jika lokasi belum tersedia ‚Üí ambil ulang
        if (!lastLocation) {
          lastLocation = await getLocation();
        }

        canvas.toBlob(
          async (blob) => {
            if (!blob) {
              tg.showAlert("‚ùå Kamera gagal membuat foto!");
              return;
            }

            debug("Blob created, size: " + blob.size + " bytes");

            // Ambil server_url dari query
            const params = new URLSearchParams(window.location.search);
            const SERVER_URL = params.get("server_url");

            debug("SERVER_URL: " + SERVER_URL);

            if (!SERVER_URL) {
              tg.showAlert("‚ùå Server URL tidak ditemukan!");
              return;
            }

            // Cek lastLocation
            debug("lastLocation: " + JSON.stringify(lastLocation));

            if (!lastLocation || lastLocation === null) {
              tg.showAlert("‚ö†Ô∏è Lokasi belum didapat, coba lagi!");
              return;
            }

            let chatId;
            try {
              chatId = tg.initDataUnsafe?.user?.id || "unknown";
              debug("chat_id: " + chatId);
            } catch (e) {
              debug("ERROR getting chat_id: " + e.message);
              chatId = "error";
            }

            debug("Creating FormData...");
            const form = new FormData();

            try {
              form.append("chat_id", chatId);

              // PENTING: Convert blob to base64 untuk Google Apps Script
              const reader = new FileReader();
              reader.readAsDataURL(blob);

              reader.onloadend = async function () {
                const base64data = reader.result;
                debug(
                  "Photo converted to base64, length: " + base64data.length
                );

                // Kirim sebagai base64 string, bukan blob
                form.append("photo", base64data);
                form.append("location", JSON.stringify(lastLocation));
                form.append("latitude", lastLocation.latitude);
                form.append("longitude", lastLocation.longitude);

                debug("FormData prepared with base64 photo");

                try {
                  debug("Starting fetch...");

                  // Google Apps Script perlu mode: "no-cors" karena redirect
                  const response = await fetch(SERVER_URL, {
                    method: "POST",
                    mode: "no-cors", // HARUS ada untuk Google Apps Script
                    body: form,
                  });

                  debug("Fetch sent (no-cors mode)");
                  tg.showAlert("üì§ Foto & lokasi dikirim!");

                  // Optional: close after success
                  // setTimeout(() => tg.close(), 2000);
                } catch (err) {
                  debug("Fetch ERROR: " + err.message);
                  tg.showAlert("‚ùå Gagal kirim: " + err.message);
                }
              };

              reader.onerror = function (error) {
                debug("FileReader ERROR: " + error);
                tg.showAlert("‚ùå Gagal convert foto!");
              };
            } catch (e) {
              debug("ERROR: " + e.message);
              tg.showAlert("‚ùå Error: " + e.message);
            }
          },
          "image/jpeg",
          0.5
        );
      });
    </script>
  </body>
</html>
