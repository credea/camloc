<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <title>Absensi Kamera</title>

    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        margin: 0;
        padding: 1rem;
        background: #f5f5f5;
      }

      video {
        width: 100%;
        max-width: 320px;
        border-radius: 10px;
        background: #000;
      }

      button {
        display: block;
        margin: 1rem auto;
        padding: 0.8rem 1.2rem;
        font-size: 1.2rem;
        border: none;
        border-radius: 8px;
        background: #28a745;
        color: white;
        cursor: pointer;
      }

      button:active {
        background: #218838;
      }

      #status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }

      #location {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
    </style>
  </head>

  <body>
    <h3>üì∑ Absensi dengan Foto</h3>

    <video id="video" autoplay playsinline muted></video>
    <p id="status">‚è≥ Loading kamera...</p>
    <p id="location"></p>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      const video = document.getElementById("video");
      const status = document.getElementById("status");
      const locText = document.getElementById("location");

      let lastLocation = null; // Lokasi realtime tersimpan di sini
      let locationRetry = 0;
      const MIN_ACCURACY = 25; // meter
      const MAX_RETRY = 3;

      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
          });

          video.srcObject = stream;
          await video.play();
          status.innerText = "‚úÖ Kamera aktif";

          // Setelah kamera aktif ‚Üí ambil lokasi awal
          setTimeout(() => getLocationBackground(), 500);
        } catch (err) {
          status.innerText = "‚ùå Gagal akses kamera: " + err.message;
        }
      }

      startCamera();

      // -------------------------
      // FUNGSI GET LOCATION
      // -------------------------
      function getLocation() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) return resolve(null);

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              resolve({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
              });
            },
            (err) => {
              tg.showAlert(
                "‚ö†Ô∏è Aktifkan lokasi untuk Telegram.\nError: " + err.message
              );
              resolve(null); // jangan menghentikan program, tetap lanjut
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 3000 }
          );
        });
      }

      // -------------------------
      // GET LOCATION OTOMATIS SETELAH KAMERA AKTIF
      // -------------------------
      async function getLocationBackground() {
        locText.innerText = "üìç Mengambil lokasi...";
        tg.MainButton.hide(); // tombol disembunyikan dulu

        lastLocation = await getLocation();

        if (lastLocation) {
          locText.innerText =
            `üìç Lokasi: ${lastLocation.lat.toFixed(
              5
            )}, ${lastLocation.lng.toFixed(5)}` +
            ` (¬±${lastLocation.accuracy}m)`;
        } else {
          locText.innerText = "üìç Lokasi tidak tersedia";
        }

        // CEK AKURASI
        if (lastLocation && lastLocation.accuracy <= MIN_ACCURACY) {
          tg.MainButton.show();
          return; // selesai
        }

        // Jika akurasi buruk ‚Üí cek apakah sudah 3x
        if (locationRetry < MAX_RETRY) {
          locationRetry++;
          locText.innerText += `\n‚è≥ Mencari lokasi lebih akurat... (percobaan ${locationRetry})`;
          setTimeout(getLocationBackground, 3000); // ulang lagi
        } else {
          // SUDAH 3x COBA, berhenti
          locText.innerText +=
            "\n‚ö†Ô∏è Lokasi tidak cukup akurat (maks 3 percobaan).";
          tg.MainButton.show();
        }
      }

      function splitIntoChunks(str, chunkSize = 50000) {
        const chunks = [];
        for (let i = 0; i < str.length; i += chunkSize) {
          chunks.push(str.substring(i, i + chunkSize));
        }
        return chunks;
      }

      async function uploadPhotoChunked(base64, location) {
        const chatId = tg.initDataUnsafe.user.id;

        const params = new URLSearchParams(window.location.search);
        const SERVER_URL = params.get("server_url");

        const chunks = splitIntoChunks(base64, 50000);
        const totalChunks = chunks.length;

        status.innerText = "üì§ Upload ke server...";

        // STEP 1: INIT
        await fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "init",
            chat_id: chatId,
            totalChunks: totalChunks,
            location: location,
          }),
        });

        // STEP 2: UPLOAD CHUNKS
        for (let i = 0; i < totalChunks; i++) {
          await fetch(SERVER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "chunk",
              chat_id: chatId,
              index: i,
              data: chunks[i],
            }),
          });
        }

        // STEP 3: FINISH
        await fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "finish",
            chat_id: chatId,
          }),
        });
      }

      // -------------------------
      // BUTTON ABSEN
      // -------------------------
      tg.MainButton.setText("‚úÖ Absen");
      tg.MainButton.show();

      tg.MainButton.onClick(async () => {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        if (!canvas.width || !canvas.height) {
          tg.showAlert("‚ùå Video belum siap!");
          return;
        }

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64 = canvas.toDataURL("image/jpeg", 0.8);

        status.innerText = "üì§ Mengirim ke server...";

        // Jika lokasi belum tersedia ‚Üí ambil ulang
        if (!lastLocation) {
          lastLocation = await getLocation();
        }

        await uploadPhotoChunked(base64, lastLocation);

        // Ambil URL server dari query param
        // const params = new URLSearchParams(window.location.search);
        // const SERVER_URL = params.get("server_url");

        // // fetch(SERVER_URL, {
        // //   method: "POST",
        // //   mode: "no-cors",
        // //   headers: { "Content-Type": "application/json" },
        // //   body: JSON.stringify({
        // //     chat_id: tg.initDataUnsafe.user.id,
        // //     photo: base64,
        // //     location: lastLocation,
        // //   }),
        // // });

        // const form = new FormData();
        // form.append("chat_id", tg.initDataUnsafe.user.id);
        // form.append("photo", base64);
        // form.append("location", JSON.stringify(lastLocation));

        // fetch(SERVER_URL, {
        //   method: "POST",
        //   body: form,
        // });

        tg.showAlert("üì§ Foto & lokasi sedang dikirim...");
        setTimeout(() => tg.sendData("ok"), 2000);
        setTimeout(() => tg.close(), 2300);
      });
    </script>
  </body>
</html>
