<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
  <title>Test Fetch Large File (Base64)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h3 {
      color: #333;
    }
    #log {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.6;
    }
    .log-item {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .log-success {
      color: #28a745;
      font-weight: bold;
    }
    .log-error {
      color: #dc3545;
      font-weight: bold;
    }
    .log-info {
      color: #007bff;
    }
    .log-warning {
      color: #ff9800;
    }
    button {
      background: #0088cc;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      width: calc(50% - 10px);
    }
    button:active {
      background: #006699;
    }
    #preview {
      margin-top: 10px;
      text-align: center;
    }
    #preview canvas {
      border: 2px solid #ddd;
      border-radius: 8px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h3>Test Large File Upload (Base64)</h3>
  
  <button onclick="testSmallFile()">üì∏ Small (~2KB)</button>
  <button onclick="testMediumFile()">üì∏ Medium (~10KB)</button>
  <button onclick="testLargeFile()">üì∏ Large (~50KB)</button>
  <button onclick="testXLFile()">üì∏ X-Large (~100KB)</button>
  <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
  
  <div id="preview"></div>
  <div id="log"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const params = new URLSearchParams(window.location.search);
    const APPS_SCRIPT_URL = params.get("server_url") || "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.innerText = `[${timestamp}] ${message}`;
      logDiv.appendChild(logItem);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      document.getElementById('preview').innerHTML = '';
      log('Log cleared', 'info');
    }

    // Generate complex image
    function createComplexImage(width, height, complexity = 'medium') {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      
      // Background gradient
      const gradient = ctx.createLinearGradient(0, 0, width, height);
      gradient.addColorStop(0, '#4CAF50');
      gradient.addColorStop(0.5, '#2196F3');
      gradient.addColorStop(1, '#9C27B0');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, width, height);
      
      // Add complexity to increase file size
      if (complexity === 'high' || complexity === 'very_high') {
        for (let i = 0; i < 100; i++) {
          ctx.fillStyle = `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 0.3)`;
          ctx.beginPath();
          ctx.arc(
            Math.random() * width,
            Math.random() * height,
            Math.random() * 30 + 10,
            0,
            Math.PI * 2
          );
          ctx.fill();
        }
      }
      
      if (complexity === 'very_high') {
        const imageData = ctx.getImageData(0, 0, width, height);
        for (let i = 0; i < imageData.data.length; i += 4) {
          const noise = Math.random() * 50 - 25;
          imageData.data[i] += noise;
          imageData.data[i + 1] += noise;
          imageData.data[i + 2] += noise;
        }
        ctx.putImageData(imageData, 0, 0);
      }
      
      // Text overlay
      ctx.fillStyle = 'white';
      ctx.font = 'bold 40px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('TEST IMAGE', width/2, height/2);
      ctx.font = '20px Arial';
      ctx.fillText(`${width}x${height}`, width/2, height/2 + 40);
      
      return canvas;
    }

    async function sendImage(canvas, label) {
      const preview = document.getElementById('preview');
      preview.innerHTML = '<h4>Preview:</h4>';
      preview.appendChild(canvas);
      
      log(`Creating blob for ${label}...`, 'info');
      
      canvas.toBlob(async (blob) => {
        if (!blob) {
          log('‚ùå Blob creation failed', 'error');
          return;
        }

        const sizeKB = (blob.size / 1024).toFixed(2);
        log(`‚úÖ Blob created: ${blob.size} bytes (${sizeKB} KB)`, 'success');

        // CONVERT BLOB TO BASE64
        log('Converting blob to base64...', 'info');
        
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        
        reader.onloadend = async function() {
          const base64data = reader.result;
          const base64Length = base64data.length;
          const base64KB = (base64Length / 1024).toFixed(2);
          
          log(`‚úÖ Base64 created: ${base64Length} chars (${base64KB} KB)`, 'success');
          // log(`Base64 preview: ${base64data.substring(0, 50)}...`, 'info');
          log('ChatId: ' + tg.initDataUnsafe?.user?.id || 'unknown');

          // KIRIM SEBAGAI FORMDATA DENGAN BASE64 STRING
          const formData = new FormData();
          formData.append('action', 'test_file_size');
          formData.append('label', label);
          formData.append('size_bytes', blob.size);
          formData.append('size_kb', sizeKB);
          formData.append('base64_length', base64Length);
          formData.append('user_id', tg.initDataUnsafe?.user?.id || 'unknown');
          formData.append('timestamp', new Date().toISOString());
          formData.append('photo_base64', base64data); // ‚Üê BASE64 STRING

          log(`Sending ${sizeKB}KB (${base64KB}KB base64) to server...`, 'info');
          // log('URL: ' + APPS_SCRIPT_URL, 'info');

          const startTime = Date.now();

          try {
            // Try with CORS first
            log('Attempting with CORS...', 'info');
            
            const response = await fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              body: formData
            });

            const duration = Date.now() - startTime;
            log(`‚úÖ Response received in ${duration}ms`, 'success');
            log('Status: ' + response.status, 'info');

            const text = await response.text();
            log('Response length: ' + text.length, 'info');

            try {
              const json = JSON.parse(text);
              log('‚úÖ Server response:', 'success');
              log(JSON.stringify(json, null, 2), 'success');
              
              if (json.photo_received) {
                log('‚úÖ‚úÖ‚úÖ PHOTO RECEIVED BY SERVER!', 'success');
              }
            } catch (e) {
              log('Response preview: ' + text.substring(0, 200), 'info');
            }

            tg.showAlert(`‚úÖ ${label} sent! (${sizeKB}KB)`);

          } catch (error) {
            log('‚ùå CORS failed: ' + error.message, 'error');
            log('‚ö†Ô∏è Trying no-cors mode...', 'warning');
            
            // try {
            //   await fetch(APPS_SCRIPT_URL, {
            //     method: 'POST',
            //     mode: 'no-cors',
            //     body: formData
            //   });

            //   const duration = Date.now() - startTime;
            //   log(`‚úÖ Sent with no-cors in ${duration}ms`, 'success');
            //   log('‚ö†Ô∏è Cannot read response (no-cors limitation)', 'warning');
            //   log('‚úÖ Check Apps Script Executions to verify', 'info');
              
            //   tg.showAlert(`‚úÖ ${label} sent (no-cors)! Check server logs`);

            // } catch (e2) {
            //   log('‚ùå no-cors also failed: ' + e2.message, 'error');
            //   tg.showAlert('‚ùå Failed to send');
            // }
          }
        };
        
        reader.onerror = function(error) {
          log('‚ùå FileReader error: ' + error, 'error');
          tg.showAlert('‚ùå Failed to convert to base64');
        };

      }, 'image/jpeg', 0.9);
    }

    // Test functions
    async function testSmallFile() {
      log('=== Testing SMALL file (~2KB) ===', 'info');
      const canvas = createComplexImage(200, 200, 'low');
      await sendImage(canvas, 'small_2kb');
    }

    async function testMediumFile() {
      log('=== Testing MEDIUM file (~10KB) ===', 'info');
      const canvas = createComplexImage(400, 400, 'medium');
      await sendImage(canvas, 'medium_10kb');
    }

    async function testLargeFile() {
      log('=== Testing LARGE file (~50KB) ===', 'info');
      const canvas = createComplexImage(800, 600, 'high');
      await sendImage(canvas, 'large_50kb');
    }

    async function testXLFile() {
      log('=== Testing X-LARGE file (~100KB) ===', 'info');
      const canvas = createComplexImage(1200, 900, 'very_high');
      await sendImage(canvas, 'xlarge_100kb');
    }

    // Initial log
    log('üöÄ Large File Test Ready (Base64 method)', 'success');
    log('Apps Script URL: ' + APPS_SCRIPT_URL, 'info');
    log('User ID: ' + (tg.initDataUnsafe?.user?.id || 'unknown'), 'info');
    log('Platform: ' + tg.platform, 'info');
    log('Method: Blob ‚Üí Base64 ‚Üí FormData', 'info');
    log('Ready to test!', 'success');
  </script>
</body>
</html>
