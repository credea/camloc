<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
  <title>Test Fetch to Apps Script</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h3 {
      color: #333;
    }
    #log {
      background: #fff;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.6;
    }
    .log-item {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .log-success {
      color: #28a745;
    }
    .log-error {
      color: #dc3545;
    }
    .log-info {
      color: #007bff;
    }
    button {
      background: #0088cc;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      width: calc(50% - 10px);
    }
    button:active {
      background: #006699;
    }
  </style>
</head>
<body>
  <h3>Test Fetch to Apps Script</h3>
  
  <button onclick="testFetchGET()">üîç Test GET</button>
  <button onclick="testFetchPOSTFormData()">üì§ Test POST (FormData)</button>
  <button onclick="testFetchPOSTNoCors()">üì§ Test POST (no-cors)</button>
  <button onclick="testFetchPOSTWithFile()">üì∏ Test POST (with file)</button>
  <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
  
  <div id="log"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Ambil URL dari query parameter
    const params = new URLSearchParams(window.location.search);
    const APPS_SCRIPT_URL = params.get("server_url") || "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

    // Logger function
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.innerText = `[${timestamp}] ${message}`;
      logDiv.appendChild(logItem);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('Log cleared', 'info');
    }

    // Test 1: GET Request
    async function testFetchGET() {
      log('üîç Starting GET request...', 'info');
      log('URL: ' + APPS_SCRIPT_URL, 'info');

      try {
        const startTime = Date.now();
        
        const response = await fetch(APPS_SCRIPT_URL + '?test=get&time=' + Date.now(), {
          method: 'GET',
        });

        const duration = Date.now() - startTime;
        log(`‚úÖ Response received (${duration}ms)`, 'success');
        log('Status: ' + response.status, 'info');
        log('StatusText: ' + response.statusText, 'info');

        const text = await response.text();
        log('Response length: ' + text.length + ' chars', 'info');
        log('Response preview: ' + text.substring(0, 150), 'success');

        tg.showAlert('‚úÖ GET Success!');

      } catch (error) {
        log('‚ùå GET Error: ' + error.message, 'error');
        tg.showAlert('‚ùå GET Failed: ' + error.message);
      }
    }

    // Test 2: POST with FormData (WORKING method for Apps Script)
    async function testFetchPOSTFormData() {
      log('üì§ Starting POST with FormData...', 'info');
      log('URL: ' + APPS_SCRIPT_URL, 'info');

      try {
        const startTime = Date.now();
        
        const formData = new FormData();
        formData.append('action', 'test_post');
        formData.append('message', 'Hello from FormData POST');
        formData.append('timestamp', new Date().toISOString());
        formData.append('user_id', tg.initDataUnsafe?.user?.id || 'unknown');
        formData.append('platform', tg.platform);

        log('FormData created with 5 fields', 'info');

        // Try WITHOUT no-cors first to see response
        log('Attempting POST with CORS...', 'info');
        
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const duration = Date.now() - startTime;
        log(`‚úÖ Response received (${duration}ms)`, 'success');
        log('Status: ' + response.status, 'info');

        const text = await response.text();
        log('Response: ' + text.substring(0, 200), 'success');

        try {
          const json = JSON.parse(text);
          log('‚úÖ Parsed JSON response:', 'success');
          log(JSON.stringify(json, null, 2), 'success');
        } catch (e) {
          log('Response is not JSON', 'info');
        }

        tg.showAlert('‚úÖ POST FormData Success!');

      } catch (error) {
        log('‚ùå POST Error: ' + error.message, 'error');
        log('‚ö†Ô∏è CORS blocked! Trying no-cors mode...', 'info');
        
        // Fallback to no-cors
        try {
          const formData = new FormData();
          formData.append('action', 'test_post');
          formData.append('message', 'Hello from FormData POST (no-cors)');
          formData.append('timestamp', new Date().toISOString());
          formData.append('user_id', tg.initDataUnsafe?.user?.id || 'unknown');

          await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: formData
          });

          log('‚úÖ Sent with no-cors mode', 'success');
          log('‚ö†Ô∏è Cannot read response (no-cors limitation)', 'info');
          tg.showAlert('‚úÖ Sent! Check Apps Script logs');
        } catch (e2) {
          log('‚ùå no-cors also failed: ' + e2.message, 'error');
          tg.showAlert('‚ùå All methods failed');
        }
      }
    }

    // Test 3: POST with no-cors from start
    async function testFetchPOSTNoCors() {
      log('üì§ Starting POST with no-cors mode...', 'info');
      log('URL: ' + APPS_SCRIPT_URL, 'info');

      try {
        const startTime = Date.now();
        
        const formData = new FormData();
        formData.append('action', 'test_nocors');
        formData.append('message', 'Testing no-cors mode');
        formData.append('timestamp', new Date().toISOString());
        formData.append('user_id', tg.initDataUnsafe?.user?.id || 'unknown');

        log('Sending with mode: no-cors...', 'info');

        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          body: formData
        });

        const duration = Date.now() - startTime;
        log(`‚úÖ Request sent (${duration}ms)`, 'success');
        log('‚ö†Ô∏è Response cannot be read (no-cors)', 'info');
        log('‚úÖ Check Apps Script Executions log to verify', 'info');

        tg.showAlert('‚úÖ Sent! Check server logs');

      } catch (error) {
        log('‚ùå Error: ' + error.message, 'error');
        tg.showAlert('‚ùå Failed: ' + error.message);
      }
    }

    // Test 4: POST with File (dummy image)
    async function testFetchPOSTWithFile() {
      log('üì∏ Creating dummy image...', 'info');

      try {
        // Create dummy canvas image
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');
        
        // Draw something
        ctx.fillStyle = '#4CAF50';
        ctx.fillRect(0, 0, 200, 200);
        ctx.fillStyle = 'white';
        ctx.font = '30px Arial';
        ctx.fillText('TEST', 60, 110);

        log('Canvas created', 'success');

        canvas.toBlob(async (blob) => {
          if (!blob) {
            log('‚ùå Blob creation failed', 'error');
            return;
          }

          log('‚úÖ Blob created: ' + blob.size + ' bytes', 'success');

          const formData = new FormData();
          formData.append('action', 'test_file');
          formData.append('user_id', tg.initDataUnsafe?.user?.id || 'unknown');
          formData.append('timestamp', new Date().toISOString());
          formData.append('photo', blob, 'test.jpg');

          log('FormData with file ready', 'info');
          log('Sending with no-cors...', 'info');

          try {
            await fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              body: formData
            });

            log('‚úÖ File sent!', 'success');
            log('Check Apps Script logs to see file data', 'info');
            tg.showAlert('‚úÖ File sent! Check logs');

          } catch (error) {
            log('‚ùå Send error: ' + error.message, 'error');
            tg.showAlert('‚ùå Failed: ' + error.message);
          }

        }, 'image/jpeg', 0.8);

      } catch (error) {
        log('‚ùå Error: ' + error.message, 'error');
        tg.showAlert('‚ùå Failed: ' + error.message);
      }
    }

    // Initial log
    log('üöÄ Test page loaded', 'success');
    log('Apps Script URL: ' + APPS_SCRIPT_URL, 'info');
    log('User ID: ' + (tg.initDataUnsafe?.user?.id || 'unknown'), 'info');
    log('Platform: ' + tg.platform, 'info');
    log('Version: Telegram WebApp ' + tg.version, 'info');
    log('Ready to test!', 'success');
  </script>
</body>
</html>
